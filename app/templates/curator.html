{% extends "base.html" %}
{% block content %}

<div class="max-w-7xl mx-auto">

    <!-- Header -->
    <div class="mb-10">
        <h1 class="text-4xl font-bold text-caramel">
            Curator Console
        </h1>
        <p class="text-cream opacity-70 mt-2">
            Manager Analytics & Caf√© Insights
        </p>
    </div>

    <!-- KPI Cards -->
    <div id="kpiSection"
         class="grid sm:grid-cols-2 xl:grid-cols-3 gap-8 mb-12 transition-opacity duration-400">

        <div class="card p-6 text-center">
            <div class="text-sm opacity-60">Total Orders</div>
            <div id="totalOrders"
                 class="text-3xl font-bold text-caramel mt-2">
                0
            </div>
        </div>

        <div class="card p-6 text-center">
            <div class="text-sm opacity-60">Completed</div>
            <div id="completedOrders"
                 class="text-3xl font-bold text-green-400 mt-2">
                0
            </div>
        </div>

        <div class="card p-6 text-center">
            <div class="text-sm opacity-60">Pending / In Progress</div>
            <div id="pendingOrders"
                 class="text-3xl font-bold text-yellow-400 mt-2">
                0
            </div>
        </div>

    </div>

    <!-- Charts -->
    <div id="chartSection"
         class="grid lg:grid-cols-2 gap-10 transition-opacity duration-400">

        <div class="card p-8">
            <h2 class="text-lg font-semibold text-caramel mb-6">
                Weekly Revenue Trend
            </h2>
            <canvas id="revenueChart"></canvas>
        </div>

        <div class="card p-8">
            <h2 class="text-lg font-semibold text-caramel mb-6">
                Order Distribution
            </h2>
            <canvas id="statusChart"></canvas>
        </div>

    </div>

</div>

<script>

let revenueChart;
let statusChart;

/* Animate Counter */
function animateValue(id, end) {
    let start = 0;
    let duration = 1000;
    let range = end - start;
    let increment = end > start ? 1 : -1;
    let stepTime = Math.abs(Math.floor(duration / (range || 1)));
    let obj = document.getElementById(id);

    let timer = setInterval(function() {
        start += increment;
        obj.textContent = start;
        if (start == end) clearInterval(timer);
    }, stepTime);
}

/* Initialize Dashboard */
function initDashboard(data){

    animateValue("totalOrders", data.total_orders);
    animateValue("completedOrders", data.completed_orders);
    animateValue("pendingOrders", data.pending_orders);

    if(revenueChart) revenueChart.destroy();
    if(statusChart) statusChart.destroy();

    revenueChart = new Chart(document.getElementById('revenueChart'), {
        type: 'line',
        data: {
            labels: data.revenue_labels,
            datasets: [{
                label: 'Revenue ($)',
                data: data.revenue_data,
                borderColor: '#c08a4d',
                backgroundColor: 'rgba(192,138,77,0.15)',
                tension: 0.4,
                fill: true,
                pointRadius: 4
            }]
        },
        options: {
            responsive: true,
            animation: { duration: 1200 },
            plugins: {
                legend: { labels: { color: '#f5e6d3' } }
            },
            scales: {
                x: { ticks: { color: '#f5e6d3' } },
                y: { ticks: { color: '#f5e6d3' } }
            }
        }
    });

    statusChart = new Chart(document.getElementById('statusChart'), {
        type: 'doughnut',
        data: {
            labels: ['Completed', 'Pending / In Progress'],
            datasets: [{
                data: [data.completed_orders, data.pending_orders],
                backgroundColor: ['#22c55e','#facc15']
            }]
        },
        options: {
            responsive: true,
            animation: { duration: 1200 },
            plugins: {
                legend: { labels: { color: '#f5e6d3' } }
            }
        }
    });
}

/* Initial Load */
initDashboard({
    total_orders: {{ total_orders }},
    completed_orders: {{ completed_orders }},
    pending_orders: {{ pending_orders }},
    revenue_labels: {{ revenue_labels | safe }},
    revenue_data: {{ revenue_data | safe }}
});

/* Auto Refresh Every 30s */
setInterval(()=>{

    const kpi = document.getElementById("kpiSection");
    const charts = document.getElementById("chartSection");

    kpi.style.opacity = "0.4";
    charts.style.opacity = "0.4";

    fetch(window.location.href)
        .then(res=>res.text())
        .then(html=>{
            const parser = new DOMParser();
            const doc = parser.parseFromString(html,"text/html");

            const scriptData = {
                total_orders: {{ total_orders }},
                completed_orders: {{ completed_orders }},
                pending_orders: {{ pending_orders }},
                revenue_labels: {{ revenue_labels | safe }},
                revenue_data: {{ revenue_data | safe }}
            };

            setTimeout(()=>{
                initDashboard(scriptData);
                kpi.style.opacity = "1";
                charts.style.opacity = "1";
            },400);
        });

},30000);

</script>

{% endblock %}
